<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Experiment Admin Dashboard</title>
  <style>
    :root { --bg:#0b1020; --panel:#121a35; --border:#2a3359; --muted:#9aa3c7; --accent:#667eea; }
    html, body { margin:0; background: var(--bg); color: #e8ecff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; padding: 32px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 24px; }
    h1 { margin:0; font-size: 28px; font-weight: 800; letter-spacing:.2px;}
    .content { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { text-align:left; padding: 12px 10px; border-bottom: 1px solid var(--border); }
    th { color:#cdd5ff; font-weight:700; font-size: 13px; text-transform: uppercase; letter-spacing:.06em;}
    td { color:#e8ecff; font-size: 15px;}
    .status { padding: 6px 10px; border-radius: 999px; font-size:12px; font-weight:700; }
    .status-active { background: rgba(102,126,234,0.18); border: 1px solid #667eea; color:#dbe1ff;}
    .status-draft { background: rgba(255,255,255,0.08); border: 1px solid var(--border); color:#dcdff0;}
    .btn { background: #667eea; border: 1px solid #5364d4; color: white; padding: 10px 14px; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; text-decoration: none; display:inline-block; transition: transform .06s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn-secondary { background: transparent; border-color: var(--border); color: #e8ecff;}
  
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
    .toast { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; border-left: 4px solid var(--accent); color: #e8ecff; }
    .toast.success { border-left-color: #48bb78; }
    .toast.error { border-left-color: #fc8181; }
    .toast.warning { border-left-color: #f6ad55; }
    .toast-icon { font-size: 1.5em; }
    .toast-content { flex: 1; }
    .toast-title { font-weight: 600; margin-bottom: 4px; }
    .toast-message { font-size: 0.9em; opacity: 0.8; }
    .toast-close { background: none; border: none; color: inherit; cursor: pointer; padding: 0; width: 24px; height: 24px; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
</style>
</head>
<body>
  <div id="toastContainer" class="toast-container"></div>

  <div class="container">
    <div class="header">
      <h1>Experiment Admin Dashboard</h1>
      <a class="btn" href="experimenter_dashboard_improved.html">+ Create New Experiment</a>
    </div>
    <div class="content">
      <h2 style="margin-top:0">All Experiments</h2>
      <table>
        <thead>
          <tr>
            <th>Experiment Name</th>
            <th>Status</th>
            <th>Created</th>
            <th>Subjects</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="exp-table-body"></tbody>
      </table>
    </div>
  </div>
  <script>
    const API_BASE = 'http://localhost:5000/api';
    async function loadExperiments() {
      try {
        const response = await fetch(`${API_BASE}/experiments/all`);
        if (!response.ok) throw new Error('Failed to fetch experiments');
        const data = await response.json();
        const experiments = data.experiments || [];
        const tableBody = document.getElementById('exp-table-body');
        tableBody.innerHTML = '';

        if (experiments.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">No experiments found.</td></tr>';
          return;
        }

        experiments.forEach(exp => {
          const row = document.createElement('tr');
          const createdDate = new Date(exp.created_at).toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'});
          row.innerHTML = `
            <td><strong>${exp.name}</strong></td>
            <td><span class="status status-${exp.status}">${exp.status}</span></td>
            <td>${createdDate}</td>
            <td>${exp.session_count || 0}</td>
            <td>
              <a href="results_dashboard.html?exp=${exp.experiment_id}" class="btn">View Results</a>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error(error);
        const tableBody = document.getElementById('exp-table-body');
        tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px; color: #ffb4b4;">${error.message}</td></tr>`;
      }
    }
    window.addEventListener('DOMContentLoaded', loadExperiments);
  </script>

<section style="margin-top:24px; padding:12px; border:1px solid #ddd; border-radius:8px;">
  <h2>Consent & Debrief</h2>
  <p>Upload your IRB-approved consent and debrief documents (HTML or PDF). The participant page will display the current consent.</p>
  <div style="display:flex; gap:16px; flex-wrap:wrap;">
    <form onsubmit="return false;">
      <label>Consent: <input type="file" id="consentFile"></label>
      <button onclick="uploadConsent()">Upload</button>
    </form>
    <form onsubmit="return false;">
      <label>Debrief: <input type="file" id="debriefFile"></label>
      <button onclick="uploadDebrief()">Upload</button>
    </form>
  </div>
  <div style="margin-top:8px">
    <a href="/api/consent" target="_blank">Preview consent</a> • <a href="/api/debrief" target="_blank">Preview debrief</a>
  </div>
</section>
<script>
function authHeader(){ const t=localStorage.getItem('jwt'); return t? {'Authorization':'Bearer '+t} : {}; }
async function uploadConsent(){
  const f=document.getElementById('consentFile').files[0]; if(!f){ alert('Pick a file'); return; }
  const fd=new FormData(); fd.append('file',f);
  const r=await fetch('/api/admin/upload_consent',{method:'POST',headers:authHeader(),body:fd});
  const d=await r.json(); if(!r.ok){ alert('Upload failed: '+JSON.stringify(d)); } else { alert('Consent uploaded.'); }
}
async function uploadDebrief(){
  const f=document.getElementById('debriefFile').files[0]; if(!f){ alert('Pick a file'); return; }
  const fd=new FormData(); fd.append('file',f);
  const r=await fetch('/api/admin/upload_debrief',{method:'POST',headers:authHeader(),body:fd});
  const d=await r.json(); if(!r.ok){ alert('Upload failed: '+JSON.stringify(d)); } else { alert('Debrief uploaded.'); }
}


        // ===== KEYBOARD SHORTCUTS (Admin QoL + WCAG 2.1.1) =====
        const shortcuts = {
            'Alt+N': () => document.querySelector('[href*="experimenter"]')?.click(),
            'Alt+R': () => location.reload(),
            'Alt+H': () => showShortcutsHelp(),
            '/': (e) => { const search = document.querySelector('input[type="search"]'); if(search) { e.preventDefault(); search.focus(); } }
        };

        function handleKeyboardShortcut(e) {
            const key = [];
            if (e.altKey) key.push('Alt');
            if (e.ctrlKey) key.push('Ctrl');
            key.push(e.key);

            const combo = key.join('+');
            const handler = shortcuts[combo];

            if (handler) {
                e.preventDefault();
                handler(e);
            }
        }

        function showShortcutsHelp() {
            const modal = document.createElement('div');
            modal.setAttribute('role', 'dialog');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); display: flex; align-items: center;
                justify-content: center; z-index: 10000; padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: var(--panel); border: 1px solid var(--border); 
                            border-radius: 16px; max-width: 600px; padding: 32px; color: #e8ecff;">
                    <h2 style="margin-bottom: 24px; color: var(--accent);">⌨️ Keyboard Shortcuts</h2>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr><td style="padding: 12px; border-bottom: 1px solid var(--border);"><kbd style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">Alt+N</kbd></td><td style="padding: 12px; border-bottom: 1px solid var(--border);">New Experiment</td></tr>
                        <tr><td style="padding: 12px; border-bottom: 1px solid var(--border);"><kbd style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">Alt+R</kbd></td><td style="padding: 12px; border-bottom: 1px solid var(--border);">Refresh Page</td></tr>
                        <tr><td style="padding: 12px; border-bottom: 1px solid var(--border);"><kbd style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">Alt+H</kbd></td><td style="padding: 12px; border-bottom: 1px solid var(--border);">Show This Help</td></tr>
                        <tr><td style="padding: 12px;"><kbd style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">/</kbd></td><td style="padding: 12px;">Focus Search</td></tr>
                    </table>
                    <button onclick="this.closest('[role=dialog]').remove()" 
                            style="margin-top: 24px; padding: 12px 24px; background: var(--accent); 
                                   color: white; border: none; border-radius: 8px; width: 100%; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        document.addEventListener('keydown', handleKeyboardShortcut);

        // Show hint on first visit
        window.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('shortcuts_hint_shown')) {
                setTimeout(() => {
                    if (typeof showToast === 'function') {
                        showToast('Keyboard Shortcuts', 'Press Alt+H to view all shortcuts', 'info');
                    }
                    localStorage.setItem('shortcuts_hint_shown', 'true');
                }, 2000);
            }
        });


        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: '✓', error: '✗', warning: '⚠', info: 'ℹ' };
            toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><button class="toast-close" onclick="this.parentElement.remove()">×</button>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
</script>

</body>
</html>

